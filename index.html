<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Drag Keypad Demo (v0.2)</title>
  <style>
    :root{
      --gap: 12px;

      /* 기존 크기(기본) */
      --cell-min-base: 88px;
      --cell-max-base: 130px;
      --cell-size-base: clamp(var(--cell-min-base), 26vw, var(--cell-max-base));

      /* ✅ 오른손용: 버튼을 2/3로 축소 */
      --scale: 0.67;
      --cell-size: calc(var(--cell-size-base) * var(--scale));

      --radius: 18px;
    }

    /* ✅ 모바일에서 주소창/스크롤로 화면이 흔들리지 않도록 고정 */
    html, body{
      height:100%;
      margin:0;
      overflow:hidden;
      overscroll-behavior:none;
      touch-action:none;
    }

    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
      background:#fafafa; color:#111;
      display:flex; justify-content:center;
      padding:18px;
      position:fixed;
      inset:0;
    }

    .card{
      width:min(560px, 100%);
      background:#fff;
      border-radius:22px;
      box-shadow:0 16px 40px rgba(0,0,0,.10);
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .title{ font-weight:900; font-size:18px; }
    .help{ font-size:13px; color:#555; line-height:1.45; }

    /* ✅ 커서가 깜빡이는 입력창(터치로 커서 이동 가능) */
    textarea.output{
      min-height:90px;
      border:1px solid #e3e3e3;
      border-radius:16px;
      padding:12px;
      background:#fcfcfc;
      font-size:18px;
      width:100%;
      resize:none;
      box-sizing:border-box;
      outline:none;
      line-height:1.4;
      white-space:pre-wrap;
      word-break:break-word;
      overflow:auto;

      /* iOS에서 확대 방지(16px 이상이면 자동 확대 억제) */
      -webkit-text-size-adjust: 100%;
    }
    textarea.output:focus{
      border-color:#111;
      box-shadow:0 0 0 3px rgba(0,0,0,0.08);
    }

    /* ✅ 그리드를 오른쪽으로 붙임 */
    .gridwrap{
      display:flex;
      justify-content:flex-end; /* 오른쪽 정렬 */
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(3, var(--cell-size));
      gap: var(--gap);
      justify-content:end;
    }

    .cell{
      width: var(--cell-size);
      height: var(--cell-size);
      border-radius: var(--radius);
      border:1px solid #d6d6d6;
      background:#fff;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      position:relative;
      user-select:none;
      touch-action:none; /* 버튼 드래그 자체는 스크롤로 해석되지 않게 */
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:26px;
    }

    .cell.active{
      border:2px solid #111;
      background:#f2f2f2;
      box-shadow:0 10px 25px rgba(0,0,0,.18);
    }

    /* 버튼 내부 가이드(상/하/좌/우) */
    .guide{
      position:absolute;
      font-size:14px;
      font-weight:900;
      color:#666;
      line-height:1;
      pointer-events:none;
      opacity:.95;
    }
    .guide.up{ top:10px; left:50%; transform:translateX(-50%); }
    .guide.down{ bottom:10px; left:50%; transform:translateX(-50%); }
    .guide.left{ left:10px; top:50%; transform:translateY(-50%); }
    .guide.right{ right:10px; top:50%; transform:translateY(-50%); }

    /* 현재 드래그 방향 강조 */
    .guide.sel{
      color:#111;
      background: rgba(0,0,0,0.08);
      padding:4px 7px;
      border-radius:999px;
    }

    /* 기본값(가운데) */
    .base{
      font-size:26px;
      font-weight:900;
      color:#111;
      pointer-events:none;
    }

    .btnrow{
      display:flex;
      gap:10px;
      margin-top:2px;
    }

    button{
      flex:1;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid #e3e3e3;
      background:#fff;
      font-weight:900;
      cursor:pointer;
    }

    .topbar{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
      font-size:13px; color:#555;
    }
    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #e3e3e3;
      font-weight:900;
      background:#fff;
      color:#111;
      user-select:none;
    }
    .pill.on{
      background:#111; color:#fff; border-color:#111;
    }

    @media (max-width: 360px){
      .guide{ font-size:13px; }
      .base{ font-size:24px; }
    }
  </style>
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <div class="card">
    <div class="title">영문 입력 (드래그 키패드 데모) v0.2</div>
    <div class="help">
      버튼을 누른 채로 ↑ ↓ ← → 드래그 후 떼면 해당 방향의 글자가 입력됩니다.<br/>
      드래그 없이 떼면 가운데 기본값이 입력됩니다. (PC는 마우스로 누른 채 드래그)<br/>
      ✅ 입력창을 터치하면 커서가 이동하며, 커서 위치에 글자가 삽입됩니다.
    </div>

    <div class="topbar">
      <div>가이드는 항상 버튼 내부에 표시됩니다(오버레이 없음).</div>
      <div id="shiftPill" class="pill">SHIFT: OFF</div>
    </div>

    <textarea id="output" class="output" readonly spellcheck="false">여기에 입력 결과가 표시됩니다…</textarea>

    <div class="gridwrap">
      <div id="grid" class="grid"></div>
    </div>

    <div class="btnrow">
      <button id="clear">전체 지우기</button>
      <button id="newline">줄바꿈</button>
    </div>
  </div>

<script>
  const DRAG_THRESHOLD = 18;

  // ✅ 9개 버튼 매핑 (필요하면 여기만 수정)
  const KEYS = [
    // Row 1
    { id: 1, base: "A", up:"B", right:"C", down:"D", left:"E" },
    { id: 2, base: "F", up:"G", right:"H", down:"I", left:"J" },
    { id: 3, base: "K", up:"L", right:"M", down:"N", left:"O" },

    // Row 2
    { id: 4, base: "P", up:"Q", right:"R", down:"S", left:"T" },
    { id: 5, base: "V", up:"U", right:"W", down:"X", left:"Y" },
    { id: 6, base: "Z", up:".", right:"?", down:"!", left:"," },

    // Row 3 (예시 기능키)
    { id: 7, base: "⇧", up:"⇧", right:"⇧", down:"⇧", left:"⇧", type:"shift" },
    { id: 8, base: "␣", up:"␣", right:"␣", down:"␣", left:"␣", type:"space" },
    { id: 9, base: "⌫", up:"⌫", right:"⌫", down:"⌫", left:"⌫", type:"backspace" },
  ];

  const grid = document.getElementById("grid");
  const outputEl = document.getElementById("output");
  const clearBtn = document.getElementById("clear");
  const newlineBtn = document.getElementById("newline");
  const shiftPill = document.getElementById("shiftPill");

  let text = "";
  let shift = false;

  let active = null;     // { keyDef, cell }
  let activeDir = "base";
  let pointerId = null;
  let start = { x:0, y:0 };

  function ensureFocus(){
    // readonly라도 포커스/커서는 보여줍니다(모바일에서 키보드가 뜨는 것도 줄어듦).
    outputEl.focus({preventScroll:true});
  }

  function setCaret(pos){
    const p = Math.max(0, Math.min(pos, text.length));
    outputEl.selectionStart = p;
    outputEl.selectionEnd = p;
  }

  function insertAtCaret(str){
    ensureFocus();
    const s = outputEl.selectionStart ?? text.length;
    const e = outputEl.selectionEnd ?? text.length;
    text = text.slice(0, s) + str + text.slice(e);
    outputEl.value = text || "여기에 입력 결과가 표시됩니다…";
    const next = s + str.length;
    setCaret(next);
  }

  function backspaceAtCaret(){
    ensureFocus();
    const s = outputEl.selectionStart ?? text.length;
    const e = outputEl.selectionEnd ?? text.length;

    // 선택영역이 있으면 선택 삭제
    if (e > s){
      text = text.slice(0, s) + text.slice(e);
      outputEl.value = text || "여기에 입력 결과가 표시됩니다…";
      setCaret(s);
      return;
    }

    // 커서 앞 1글자 삭제
    if (s <= 0) return;
    text = text.slice(0, s-1) + text.slice(s);
    outputEl.value = text || "여기에 입력 결과가 표시됩니다…";
    setCaret(s-1);
  }

  function renderShift(){
    shiftPill.textContent = `SHIFT: ${shift ? "ON" : "OFF"}`;
    shiftPill.classList.toggle("on", !!shift);
  }

  function dirFromDelta(dx, dy){
    const adx = Math.abs(dx), ady = Math.abs(dy);
    if (adx < DRAG_THRESHOLD && ady < DRAG_THRESHOLD) return "base";
    if (adx >= ady) return dx > 0 ? "right" : "left";
    return dy > 0 ? "down" : "up";
  }

  function commit(keyDef, dir){
    if (!keyDef) return;

    if (keyDef.type === "space"){
      insertAtCaret(" ");
      return;
    }
    if (keyDef.type === "backspace"){
      backspaceAtCaret();
      return;
    }
    if (keyDef.type === "shift"){
      shift = !shift;
      renderShift();
      return;
    }

    const ch = (dir === "up") ? keyDef.up
             : (dir === "right") ? keyDef.right
             : (dir === "down") ? keyDef.down
             : (dir === "left") ? keyDef.left
             : keyDef.base;

    const out = shift ? String(ch).toUpperCase() : String(ch).toLowerCase();
    insertAtCaret(out);

    // 한 글자 입력 후 shift 해제(유지하고 싶으면 아래 2줄 삭제)
    if (shift){
      shift = false;
      renderShift();
    }
  }

  function clearSelectionStyles(){
    [...grid.children].forEach(cell=>{
      cell.classList.remove("active");
      cell.querySelectorAll(".guide").forEach(g=>g.classList.remove("sel"));
    });
  }

  function updateGuideSelection(cell){
    cell.querySelectorAll(".guide").forEach(g=>g.classList.remove("sel"));
    if (activeDir === "up") cell.querySelector(".guide.up")?.classList.add("sel");
    if (activeDir === "right") cell.querySelector(".guide.right")?.classList.add("sel");
    if (activeDir === "down") cell.querySelector(".guide.down")?.classList.add("sel");
    if (activeDir === "left") cell.querySelector(".guide.left")?.classList.add("sel");
  }

  function makeCell(keyDef){
    const cell = document.createElement("div");
    cell.className = "cell";
    cell.dataset.keyId = keyDef.id;

    const gUp = document.createElement("div");
    gUp.className = "guide up";
    gUp.textContent = keyDef.up;

    const gRight = document.createElement("div");
    gRight.className = "guide right";
    gRight.textContent = keyDef.right;

    const gDown = document.createElement("div");
    gDown.className = "guide down";
    gDown.textContent = keyDef.down;

    const gLeft = document.createElement("div");
    gLeft.className = "guide left";
    gLeft.textContent = keyDef.left;

    const base = document.createElement("div");
    base.className = "base";
    base.textContent = keyDef.base;

    cell.appendChild(gUp);
    cell.appendChild(gRight);
    cell.appendChild(gDown);
    cell.appendChild(gLeft);
    cell.appendChild(base);

    cell.addEventListener("pointerdown", (e)=>{
      // 화면 고정(주소창/스크롤 방지) + 포커스 유지
      e.preventDefault();
      ensureFocus();

      cell.setPointerCapture?.(e.pointerId);
      pointerId = e.pointerId;

      start = { x: e.clientX, y: e.clientY };
      active = { keyDef, cell };
      activeDir = "base";

      clearSelectionStyles();
      cell.classList.add("active");
      updateGuideSelection(cell);
    });

    cell.addEventListener("pointermove", (e)=>{
      if (pointerId == null || e.pointerId !== pointerId || !active) return;

      const dx = e.clientX - start.x;
      const dy = e.clientY - start.y;

      const dir = dirFromDelta(dx, dy);
      activeDir = (dir === "base") ? "base" : dir;

      updateGuideSelection(active.cell);
    });

    const end = (e)=>{
      if (pointerId == null || e.pointerId !== pointerId || !active) return;

      const dx = e.clientX - start.x;
      const dy = e.clientY - start.y;
      const dir = dirFromDelta(dx, dy);

      commit(active.keyDef, dir);

      pointerId = null;
      active = null;
      activeDir = "base";
      clearSelectionStyles();
    };

    cell.addEventListener("pointerup", end);
    cell.addEventListener("pointercancel", end);

    return cell;
  }

  // 초기 렌더
  KEYS.forEach(k => grid.appendChild(makeCell(k)));

  // 초기 상태: placeholder
  outputEl.value = "여기에 입력 결과가 표시됩니다…";

  // ✅ 터치/클릭으로 커서 위치 이동(기본 동작 유지)
  outputEl.addEventListener("pointerdown", ()=>{
    ensureFocus();
    // readonly라도 사용자가 탭한 위치로 커서가 이동합니다.
    // (브라우저가 처리)
  });

  clearBtn.addEventListener("click", ()=>{
    text = "";
    outputEl.value = "여기에 입력 결과가 표시됩니다…";
    ensureFocus();
    setCaret(0);
  });

  newlineBtn.addEventListener("click", ()=>{
    insertAtCaret("\n");
  });

  // ✅ iOS/모바일에서 '아래로 당겨 주소창/새로고침' 등 방지
  // (passive:false 필수)
  document.addEventListener("touchmove", (e)=>{
    // 입력창 스크롤이 필요한 상황이 아니라면 전체 스크롤 차단
    // (여기는 데모라 전체 차단)
    e.preventDefault();
  }, { passive:false });

  // 화면이 흔들리면 항상 top으로 고정
  window.addEventListener("resize", ()=>window.scrollTo(0,0));
  window.scrollTo(0,0);

  renderShift();
</script>
</body>
</html>
